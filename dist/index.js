class t extends Error{statusCode;constructor(n,r){super(n);this.statusCode=r;this.name="AnnasArchiveError"}}var I="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36",T=30000;async function u(n){let r=new AbortController,o=setTimeout(()=>r.abort(),T);try{let i=await fetch(n,{headers:{"User-Agent":I},signal:r.signal});if(!i.ok)throw new t(`HTTP ${i.status}`,i.status);return await i.text()}catch(i){if(i instanceof t)throw i;throw new t(i instanceof Error?i.message:"Network request failed",0)}finally{clearTimeout(o)}}import{load as J}from"cheerio";var B={name:"semicolon",detect:(n)=>n.includes(";"),split:(n)=>n.split(";").map((r)=>r.trim()).filter(Boolean)},$={name:"period-delimited",detect:(n)=>{if(n.includes(" & ")||n.includes(" and "))return!1;return(n.match(/[a-zа-яёA-ZА-ЯЁ]{3,}\.\s*(?=[A-ZА-ЯЁ]|$)/g)||[]).length>=2},split:(n)=>{return n.split(/(?<=[a-zа-яёA-ZА-ЯЁ]{3,})\.\s+/g).map((o)=>o.trim()).filter(Boolean)}},C={name:"comma-and",detect:(n)=>n.includes(",")&&(n.includes(", and ")||n.includes(", & ")),split:(n)=>{return n.split(",").flatMap((r)=>{if(r.includes(" and ")||r.includes(" & "))return r.split(/\s+(?:and|&)\s+/);return[r]}).map((r)=>r.trim()).filter(Boolean)}},P={name:"and",detect:(n)=>n.includes(" and ")||n.includes(" & "),split:(n)=>{return n.split(/\s+(?:and|&)\s+/).map((r)=>r.trim()).filter(Boolean)}},H={name:"comma",detect:(n)=>n.includes(","),split:(n)=>{let r=n.split(",").map((o)=>o.trim());if(r.length===3){let[o,i,s]=r;if(!o||!i||!s)return r;if(s.split(/\s+/).length<=2&&/^[A-Z][a-z]{0,3}\.?$/.test(s))return[`${s} ${i} ${o}`];return[`${i} ${o}`,s]}if(r.length===2){let o=r.map((i)=>i.split(/\s+/).length);if((o[0]??0)<=3&&(o[1]??0)<=2)return[n]}return r}},m={name:"single",detect:()=>!0,split:(n)=>[n]},_=[B,$,C,P,H,m];function h(n){return _.find((r)=>r.detect(n))||m}var p=(n)=>{return n.replace(/\s*\[.*?\]\s*/g,"").trim()},M=(n)=>{return n.replace(/\s*\(.*?\)\s*/g,"").trim()},q=(n)=>{let r=n;return r=r.replace(/^(By|Illustrated\s+By)\s+/i,""),r=r.replace(/^(Составитель\s*-|Русский\sТекст\s*-|Иллюстрации\s*-)\s*/i,""),r.trim()},D=(n)=>{let r={"coll.":"Collection",coll:"Collection","ed.":"Editor",ed:"Editor","eds.":"Editors",eds:"Editors","comp.":"Compiler",comp:"Compiler","trans.":"Translator",trans:"Translator"},o=n.toLowerCase().trim();return r[o]||n},G=(n)=>{return n.replace(/([a-zа-яёA-ZА-ЯЁ]{3,})\.\s*$/i,"$1")},z=(n)=>{if(!n.includes(","))return n;let r=n.split(",");if(r.length!==2)return n;let[o,i]=r;if(!o?.trim()||!i?.trim())return n;return`${i.trim()} ${o.trim()}`},L=(n)=>{if(/^https?:\/\//i.test(n))return n;return n.split(/\s+/).map((r)=>{if(!r||r.includes("."))return r;return r.toLowerCase().replace(/(^|['-])(.)/g,(o,i,s)=>i+s.toUpperCase())}).join(" ")},j=[p,M,q,D,G,z,L];function d(n,r=j){return r.reduce((o,i)=>i(o),n)}function K(n){return["Collection","Editor","Editors","Compiler","Translator"].includes(n)}function W(n){return n.replace(/,?\s*\d{4}.*$/,"").trim()}function g(n,r){if(n.length===0)return n;if(!r?.trim())return n;if(n[0]&&K(n[0])){let o=W(r);return o?[o]:n}return n}function E(n,r){if(!n.trim())return[];let o=p(n),e=h(o).split(o).map((c)=>d(c)).filter((c)=>c.length>0);return g(e,r)}function y(n){let r=J(n),o=[];return r(".js-aarecord-list-outer .flex.pt-3").each((i,s)=>{let e=O(r,r(s));if(e)o.push(e)}),o}function O(n,r){let o=Q(r),i=R(r);if(!o||!i)return null;let s=S(r),e=V(r),c=E(s,e),f=X(r),l=r.find("img").attr("src");return{id:o,title:i,authors:c,fileType:f.fileType,fileSize:f.fileSize,year:f.year,language:f.language,thumbnail:l||void 0}}function Q(n){let r=n.find("a[href*='/md5/']").first().attr("href");if(!r)return null;let o=r.split("/");return o[o.length-1]||null}function R(n){return n.find("a").eq(1).text().trim()||null}function S(n){return n.find("a[href*='/search?q=']").first().text().trim()}function V(n){let r=n.find("a[href*='/search?q=']");if(r.length<2)return"";let o=r.eq(1);if(o.find("span[class*='company']").length>0)return o.text().trim();return""}function X(n){let o=n.find(".text-gray-800").text().split(" · ").map((l)=>l.trim()),s=(o[1]||"").replace(/\s*\[.*?\]\s*/g,"").trim(),e=o[2]||"",c=Y(o[0]),f;for(let l of o)if(f=Z(l),f!==void 0)break;return{fileType:s||void 0,fileSize:e||void 0,language:c,year:f}}function Y(n){if(!n)return;return n.match(/\[([a-z]{2,3})\]/i)?.[1]?.toLowerCase()}function Z(n){if(!n)return;let r=n.match(/\b(19|20)\d{2}\b/);return r?parseInt(r[0],10):void 0}var b="https://annas-archive.org";async function v(n){if(!n?.trim())throw TypeError("Query cannot be empty");let r=`${b}/search?&ext=epub&q=${encodeURIComponent(n)}`,o=await u(r);return y(o)}import{load as a}from"cheerio";var w="https://libgen.li";function U(n){return a(n)('a[title*="IPFS"] span.badge:contains("IPFS.io")').parent().attr("href")||null}function k(n){let o=a(n)('a[href*="ads.php"]').attr("href");if(!o)return null;return o.startsWith("http")?o:`${w}${o}`}function A(n){let o=a(n)('a[href*="get.php"]').attr("href");if(!o)return null;return o.startsWith("http")?o:`${w}/${o}`}var F="https://libgen.li";async function N(n){if(!n?.trim())throw TypeError("Book ID cannot be empty");let r={libgenMirrors:[]},o=`${F}/file.php?md5=${n}`,i=await u(o),s=U(i);if(s)r.ipfs=s;let e=k(i);if(e){let c=await u(e),f=A(c);if(f)r.libgenMirrors=[f]}return r}export{v as searchBooks,N as getDownloadUrls,t as AnnasArchiveError};
